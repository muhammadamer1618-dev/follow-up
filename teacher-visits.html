<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>زيارات المعلمين</title>

  <style>
    body{font-family:Arial,sans-serif;background:#f4f8fc;margin:0;padding:12px;color:#000}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .title{margin:0;color:#0d47a1;font-size:22px;font-weight:900}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-size:14px;cursor:pointer;font-weight:900}
    .btn.back{background:#607d8b;color:#fff;text-decoration:none}
    .btn.search{background:#1976d2;color:#fff}
    .btn.print{background:#0d47a1;color:#fff}
    .btn.del{background:#c62828;color:#fff}

    .box{background:#fff;border:1px solid #bbdefb;border-radius:12px;padding:12px}
    label{font-weight:900}
    input{width:min(420px,100%);padding:10px;border:1px solid #cfcfcf;border-radius:10px;margin-top:6px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}

    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
    th,td{border:1px solid #000;padding:8px}
    th{background:#e3f2fd;font-weight:900;text-align:center}
  </style>
</head>

<body>
  <div class="top">
    <h1 class="title">زيارات المعلمين</h1>
    <div class="actions">
      <a class="btn back" href="index.html">الرئيسية</a>
      <a class="btn back" href="evaluation-form.html">استمارة التقييم</a>
    </div>
  </div>

  <div class="box">
    <div class="row">
      <div>
        <label>كود المعلم</label>
        <input id="teacherCode" />
      </div>
      <button class="btn search" id="btnSearch">عرض الزيارات</button>
    </div>

    <table id="visitsTable" style="display:none;">
      <thead>
        <tr>
          <th>اسم المعلم</th>
          <th>التاريخ</th>
          <th>رقم الزيارة</th>
          <th>الصف</th>
          <th>المادة</th>
          <th>الدرجة</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore, collection, query, where, getDocs, doc, getDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBNFrPNCuQefOXHTCmiiKSBjgPLUy5Ug4U",
  authDomain: "follow-up-2026.firebaseapp.com",
  projectId: "follow-up-2026",
  storageBucket: "follow-up-2026.firebasestorage.app",
  messagingSenderId: "1077131515114",
  appId: "1:1077131515114:web:d10d9c5228382d7cfdb393"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const el = id => document.getElementById(id);

const esc = s => (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
const circle = on => on ? "◉" : "○";

async function loadVisits(){
  const code = el("teacherCode").value.trim();
  if(!code) return;

  const qy = query(collection(db,"visits"), where("teacherCode","==",code));
  const snap = await getDocs(qy);

  const tbody = document.querySelector("#visitsTable tbody");
  tbody.innerHTML = "";
  if(snap.empty){ alert("لا توجد زيارات"); return; }

  el("visitsTable").style.display="table";

  snap.forEach(d=>{
    const v = d.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(v.teacherName)}</td>
      <td>${esc(v.visitDate)}</td>
      <td>${v.visitNumber}</td>
      <td>${esc(v.grade)}</td>
      <td>${esc(v.subject)}</td>
      <td style="font-weight:900">${v.finalScore} / 100</td>
      <td>
        <button class="btn print" data-id="${d.id}">طباعة</button>
        <button class="btn del" data-del="${d.id}">مسح</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll(".print").forEach(b=>{
    b.onclick=()=>printVisit(b.dataset.id);
  });

  tbody.querySelectorAll(".del").forEach(b=>{
    b.onclick=async()=>{
      if(confirm("مسح الزيارة؟")){
        await deleteDoc(doc(db,"visits",b.dataset.del));
        loadVisits();
      }
    }
  });
}

async function printVisit(id){
  const snap = await getDoc(doc(db,"visits",id));
  if(!snap.exists()) return;
  const v = snap.data();

  let rows="";
  (v.answers||[]).forEach((a,i)=>{
    rows+=`
      <tr>
        <td>${i+1}</td>
        <td>${esc(a.domain)}</td>
        <td>${esc(a.itemLabel)}</td>
        <td>
          ${circle(a.selected==4)} ${esc(a.optTop)} |
          ${circle(a.selected==3)} ${esc(a.optMid)} |
          ${circle(a.selected==1)} ${esc(a.optLow)}
        </td>
      </tr>
    `;
  });

  let work="";
  (v.writtenWork||[]).forEach(r=>{
    work+=`
      <tr>
        <td>${esc(r.name)}</td>
        <td>${r.status=="correct"?"✓":""}</td>
        <td>${r.status=="partial"?"✓":""}</td>
        <td>${r.status=="not"?"✓":""}</td>
      </tr>
    `;
  });

  const html=`
<!DOCTYPE html><html dir="rtl"><head>
<meta charset="UTF-8">
<style>
@page{size:A4;margin:10mm}
body{font-family:Arial}
table{width:100%;border-collapse:collapse;font-size:11px}
td,th{border:1px solid #000;padding:5px}
th{background:#e3f2fd}
</style></head><body>

<h3 style="text-align:center">استمارة متابعة معلم</h3>

<table>
<tr><th>المعلم</th><td>${esc(v.teacherName)}</td><th>الصف</th><td>${esc(v.grade)}</td></tr>
<tr><th>المادة</th><td>${esc(v.subject)}</td><th>التاريخ</th><td>${esc(v.visitDate)}</td></tr>
</table>

<table>
<tr><th>م</th><th>المجال</th><th>العنصر</th><th>التقييم</th></tr>
${rows}
</table>

<p><b>إيجابيات:</b><br>${esc(v.positives||"")}</p>
<p><b>توصيات:</b><br>${esc(v.recommendations||"")}</p>

<table><tr><td>توقيع المعلم</td><td>توقيع المشرف</td></tr></table>

<div style="page-break-before:always"></div>

<h3 style="text-align:center">الأعمال التحريرية</h3>
<table>
<tr><th>الاسم</th><th>مصحح</th><th>غير مكتمل</th><th>غير مصحح</th></tr>
${work}
</table>

<table><tr><td>توقيع المعلم</td><td>توقيع المشرف</td></tr></table>

</body></html>
`;

  const w=window.open();
  w.document.write(html);
  w.document.close();
  setTimeout(()=>w.print(),300);
}

el("btnSearch").onclick=loadVisits;
</script>
</body>
</html>
