<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>طباعة استمارة تقييم</title>

  <style>
    @page { size: A4; margin: 12mm; }

    body{
      font-family: Arial, sans-serif;
      color:#000;
      margin:0;
      padding:0;
    }

    h2{
      text-align:center;
      margin:0 0 10px 0;
    }

    .school{
      font-weight:900;
      text-align:right;
    }

    .designer{
      font-size:12px;
      text-align:left;
      margin-bottom:10px;
    }

    .box{
      border:1px solid #000;
      padding:8px;
      margin-bottom:10px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }

    th,td{
      border:1px solid #000;
      padding:6px;
      vertical-align:middle;
      text-align:center;
    }

    th{
      background:#eee;
      font-weight:900;
    }

    .circle{
      width:14px;
      height:14px;
      border:2px solid #000;
      border-radius:50%;
      margin:auto;
      position:relative;
    }

    .circle.checked::after{
      content:"";
      width:8px;
      height:8px;
      background:#000;
      border-radius:50%;
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
    }

    .page-break{
      page-break-before: always;
    }

    .sign{
      height:60px;
    }
  </style>
</head>

<body>

  <div class="school">مدارس الفلاح الأهلية</div>
  <div class="designer">تصميم محمد عامر أحمد</div>

  <h2>استمارة تقييم زيارة صفية</h2>

  <!-- بيانات الزيارة -->
  <div class="box">
    <table>
      <tr>
        <td>اسم المعلم</td><td id="teacherName"></td>
        <td>كود المعلم</td><td id="teacherCode"></td>
      </tr>
      <tr>
        <td>الصف</td><td id="grade"></td>
        <td>المادة</td><td id="subject"></td>
      </tr>
      <tr>
        <td>عنوان الدرس</td><td colspan="3" id="lessonTitle"></td>
      </tr>
      <tr>
        <td>رقم الزيارة</td><td id="visitNumber"></td>
        <td>التاريخ</td><td id="visitDate"></td>
      </tr>
      <tr>
        <td>اسم المشرف</td><td colspan="3" id="supervisorName"></td>
      </tr>
    </table>
  </div>

  <!-- جدول البنود -->
  <table>
    <thead>
      <tr>
        <th>المجال</th>
        <th>العنصر</th>
        <th>ممتاز</th>
        <th>جيد</th>
        <th>ضعيف</th>
      </tr>
    </thead>
    <tbody id="rubricRows"></tbody>
  </table>

  <!-- إيجابيات وتوصيات -->
  <div class="box">
    <b>إيجابيات الحصة:</b>
    <div id="positives"></div>
  </div>

  <div class="box">
    <b>توصيات وتوجيهات:</b>
    <div id="recommendations"></div>
  </div>

  <table>
    <tr>
      <td>توقيع المعلم</td>
      <td>توقيع المشرف</td>
    </tr>
    <tr>
      <td class="sign"></td>
      <td class="sign"></td>
    </tr>
  </table>

  <!-- صفحة 2 -->
  <div class="page-break"></div>

  <h2>متابعة الأعمال التحريرية</h2>

  <table>
    <thead>
      <tr>
        <th>اسم الطالب</th>
        <th>مصحح</th>
        <th>غير مكتمل</th>
        <th>غير مصحح</th>
      </tr>
    </thead>
    <tbody id="workRows"></tbody>
  </table>

  <table style="margin-top:20px;">
    <tr>
      <td>توقيع المعلم</td>
      <td>توقيع المشرف</td>
    </tr>
    <tr>
      <td class="sign"></td>
      <td class="sign"></td>
    </tr>
  </table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBNFrPNCuQefOXHTCmiiKSBjgPLUy5Ug4U",
    authDomain: "follow-up-2026.firebaseapp.com",
    projectId: "follow-up-2026"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const params = new URLSearchParams(location.search);
  const id = params.get("id");

  const snap = await getDoc(doc(db,"visits",id));
  const v = snap.data();

  teacherName.textContent = v.teacherName;
  teacherCode.textContent = v.teacherCode;
  grade.textContent = v.grade;
  subject.textContent = v.subject;
  lessonTitle.textContent = v.lessonTitle;
  visitNumber.textContent = v.visitNumber;
  visitDate.textContent = v.visitDate;
  supervisorName.textContent = v.supervisorName;
  positives.textContent = v.positives;
  recommendations.textContent = v.recommendations;

  v.answers.forEach(a=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${a.domain}</td>
      <td>${a.itemLabel}</td>
      <td><div class="circle ${a.selected===4?'checked':''}"></div></td>
      <td><div class="circle ${a.selected===3?'checked':''}"></div></td>
      <td><div class="circle ${a.selected===1?'checked':''}"></div></td>
    `;
    rubricRows.appendChild(tr);
  });

  v.writtenWork.forEach(w=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${w.name}</td>
      <td>${w.status==='correct'?'✔️':''}</td>
      <td>${w.status==='partial'?'✔️':''}</td>
      <td>${w.status==='not'?'✔️':''}</td>
    `;
    workRows.appendChild(tr);
  });

  window.print();
</script>

</body>
</html>
