<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>استمارة التقييم</title>

<style>
@page{size:A4;margin:10mm}
body{font-family:Arial;background:#f4f8fc;margin:0;padding:12px}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.school{font-size:22px;font-weight:900;color:#0d47a1;margin:0}
.designer{font-size:13px;font-weight:900;margin:0}
.actions{display:flex;gap:8px}
.btn{border:0;border-radius:10px;padding:10px 14px;font-weight:900;cursor:pointer}
.btn.save{background:#2e7d32;color:#fff}
.btn.print{background:#1976d2;color:#fff}
.btn.send{background:#7b1fa2;color:#fff}
.btn.clear{background:#e3f2fd;border:1px solid #90caf9}
.layout{display:flex;gap:12px}
.box{background:#fff;border:1px solid #bbdefb;border-radius:12px;padding:12px}
.info{width:32%}
.main{width:68%}
label{font-weight:900;display:block;margin-top:8px}
input,textarea{width:100%;padding:8px;margin-top:4px;border:1px solid #ccc;border-radius:8px}
textarea{height:70px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #000;padding:6px;text-align:center}
th{background:#e3f2fd}
.scoreCell{font-weight:900}
@media print{
.topbar,.actions{display:none}
}
</style>
</head>

<body>

<div class="topbar">
  <div>
    <h1 class="school">مدارس الفلاح الأهلية</h1>
    <p class="designer">تصميم محمد عامر أحمد</p>
  </div>
  <div class="actions">
    <button class="btn print" id="btnPrint">طباعة</button>
    <button class="btn save" id="btnSave">حفظ</button>
    <button class="btn send" id="btnSend" disabled>إرسال تقرير الزيارة</button>
    <button class="btn clear" id="btnClear">تفريغ</button>
  </div>
</div>

<div class="layout">
<div class="box info">
<label>كود المعلم</label><input id="teacherCode">
<label>اسم المعلم</label><input id="teacherName">
<label>الصف</label><input id="grade">
<label>المادة</label><input id="subject">
<label>عنوان الدرس</label><input id="lessonTitle">
<label>رقم الزيارة</label><input type="number" id="visitNumber">
<label>اسم المشرف</label><input id="supervisorName">
<label>التاريخ</label><input type="date" id="visitDate">
</div>

<div class="box main">
<table>
<thead>
<tr><th>م</th><th>العنصر</th><th>4</th><th>3</th><th>1</th><th>الدرجة</th></tr>
</thead>
<tbody id="rubricBody"></tbody>
</table>

<p><b>المجموع:</b> <span id="finalScore">0</span> / 100</p>

<label>إيجابيات الحصة</label>
<textarea id="positives"></textarea>

<label>توصيات</label>
<textarea id="recommendations"></textarea>
</div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {getFirestore,doc,getDoc,collection,addDoc,serverTimestamp} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const app=initializeApp({
apiKey:"AIzaSyBNFrPNCuQefOXHTCmiiKSBjgPLUy5Ug4U",
authDomain:"follow-up-2026.firebaseapp.com",
projectId:"follow-up-2026"
});
const db=getFirestore(app);

const el=id=>document.getElementById(id);
let savedTeacherCode=null;

const items=[
"القيمة التربوية","التحضير","خطة الدرس","أهداف الدرس","المفاهيم",
"تسلسل الخطوات","الفروق الفردية","تنظيم المقاعد","نظافة الفصل",
"البيئة الصفية","إدارة الصف","القوانين الصفية","توجيهات المعلم",
"سلوك الطلاب","تفاعل الطلاب","صوت المعلم","الأسئلة","الاستراتيجية",
"الفصحى","إعلان الأهداف","الوسيلة","السبورة","التطبيق","التقويم","الملخص"
];

const tbody=el("rubricBody");
items.forEach((t,i)=>{
tbody.innerHTML+=`
<tr>
<td>${i+1}</td>
<td>${t}</td>
<td><input type="radio" name="q${i}" value="4"></td>
<td><input type="radio" name="q${i}" value="3"></td>
<td><input type="radio" name="q${i}" value="1"></td>
<td class="scoreCell" id="s${i}">0</td>
</tr>`;
});

document.addEventListener("change",()=>{
let total=0;
items.forEach((_,i)=>{
const r=document.querySelector(`input[name="q${i}"]:checked`);
const v=r?+r.value:0;
el("s"+i).textContent=v;
total+=v;
});
el("finalScore").textContent=total;
});

el("btnSave").onclick=async()=>{
savedTeacherCode=el("teacherCode").value.trim();
if(!savedTeacherCode){alert("اكتب كود المعلم");return;}
await addDoc(collection(db,"visits"),{teacherCode:savedTeacherCode,createdAt:serverTimestamp()});
el("btnSend").disabled=false;
alert("تم الحفظ");
};

el("btnSend").onclick=async()=>{
const snap=await getDoc(doc(db,"teachers",savedTeacherCode));
if(!snap.exists()){alert("لا يوجد رقم هاتف");return;}
const phone=snap.data().phone;
const msg=`السلام عليكم ورحمة الله وبركاته\nنرفق لسيادتكم تقرير زيارة الصف.\nمع خالص التحية،\nإدارة الإشراف التربوي`;
window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,"_blank");
};

el("btnPrint").onclick=()=>window.print();
el("btnClear").onclick=()=>location.reload();
</script>

</body>
</html>
